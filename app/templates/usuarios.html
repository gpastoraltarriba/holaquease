<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Cliente</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
  /* Reset b√°sico */
  * { box-sizing:border-box; margin:0; padding:0; font-family:'Inter',sans-serif; }
  body{ display:flex; min-height:100vh; background:#f4f6fc; }

  /* ============================ */
  /* Sidebar */
  /* ============================ */
  .sidebar{
    width:220px;
    background:linear-gradient(to bottom,#667eea,#764ba2);
    padding:2rem 1rem;
    color:#fff;
    flex-shrink:0;
    display: flex;
    flex-direction: column;
  }
  .sidebar h2{ margin-bottom:2rem; text-align:center; font-size:1.5rem; }

  /* Estilo base para enlaces del sidebar */
  .sidebar a{
    display:block;                     /* base */
    color:#fff;
    text-decoration:none;
    margin:1rem 0;
    padding:.75rem 1rem;
    border-radius:12px;
    transition:background .2s ease;
  }
  .sidebar a:hover{ background:rgba(255,255,255,.20); }

  /* --- √çtems horizontales (icono/imagen + texto) --- */
  /* AUMENTAMOS ESPECIFICIDAD para sobrescribir ".sidebar a" */
  .sidebar a.sidebar-item{
    display:flex;                      /* üëà fila */
    align-items:center;                /* üëà centra verticalmente */
    gap:.65rem;
    margin:.5rem 0;                    /* un poco menos de espacio */
    padding:.6rem .9rem;               /* m√°s compacto */
    background:transparent;
  }
  .sidebar a.sidebar-item:hover{ background:rgba(255,255,255,.18); }

  /* √çtem de perfil: avatar + nombre en una fila */
  .sidebar a.sidebar-profile-link{
    display:flex;                      /* asegura flex frente a display:block */
    align-items:center;                /* texto centrado con el avatar */
    gap:10px;
    padding:.45rem 1rem;
    margin-top:.75rem;
    border-radius:10px;
    background:transparent;
  }
  .sidebar a.sidebar-profile-link:hover{ background:rgba(255,255,255,.15); }

  /* Avatar del usuario */
  .sidebar-avatar{
    width:38px; height:38px;
    border-radius:50%;
    object-fit:cover;
    flex:0 0 38px;                     /* no se deforma */
    border:2px solid rgba(255,255,255,.6);
    display:block;
  }

  /* Texto del nombre justo a la derecha y centrado */
  .sidebar-label{
    display:flex;                      /* para centrar su propio contenido */
    align-items:center;                /* üî• centro vertical exacto */
    height:38px;                       /* = altura avatar */
    line-height:1;                     /* evita que baje por baseline */
    font-size:1rem; font-weight:600; color:#fff;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    max-width:140px;                   /* ajusta si tu sidebar es m√°s estrecho */
  }

  /* Estado activo opcional */
  .sidebar a.sidebar-item.is-active,
  .sidebar a.sidebar-profile-link.is-active{
    background:rgba(255,255,255,.25);
  }

  /* ============================ */
  /* Bot√≥n de cerrar sesi√≥n */
  /* ============================ */
  .sidebar-logout {
    margin-top: auto; /* Empuja el bot√≥n hacia la parte inferior */
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.2);
  }

  .sidebar-logout a {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.7rem 1rem;
    border-radius: 10px;
    transition: all 0.2s ease;
  }

  .sidebar-logout a:hover {
    background: rgba(231, 76, 60, 0.8);
    border-color: rgba(231, 76, 60, 0.5);
  }

  /* ============================ */
  /* Main */
  /* ============================ */
  .main{ flex:1; padding:2rem; overflow-y:auto; }

  /* ============================ */
  /* Top cards (KPIs) */
  /* ============================ */
  .dashboard{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:1.5rem;
  }
  .card{
    background:#fff; border-radius:20px; padding:1.5rem;
    box-shadow:0 8px 20px rgba(0,0,0,.05);
  }
  .card h3{ margin-bottom:.5rem; color:#333; }
  .kpi-value{ font-size:1.35rem; font-weight:700; color:#222; }
  .kpi-delta{ font-size:.9rem; display:inline-flex; align-items:center; gap:.35rem; margin-top:.25rem; }
  .kpi-up{ color:#18a957; font-weight:600; }
  .kpi-down{ color:#d64545; font-weight:600; }
  .kpi-flat{ color:#888; }
  .kpi-delta .arrow{ font-size:.95rem; }
  .kpi-sub{ color:#777; font-size:.85rem; margin-top:.15rem; }
  .small{ color:#999; font-size:.85rem; }

  /* ============================ */
  /* Stats section */
  /* ============================ */
  .stats{ margin-top:2rem; }
  .stats h3{ margin-bottom:1rem; }

  .no-data{
    padding:2rem; text-align:center; color:#777; font-style:italic;
  }

  /* ============================ */
  /* Charts layout & dropdowns */
  /* ============================ */
  .chart-grid{
    margin-top:1rem;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
    gap:1.25rem;
  }
  .chart-card{
    background:#fff; border-radius:16px; padding:1rem 1rem 1.25rem;
    box-shadow:0 6px 16px rgba(0,0,0,.06);
    position:relative; min-height:260px;
  }
  .chart-header{
    display:flex; align-items:flex-start; justify-content:space-between;
    margin-bottom:.5rem; gap:.75rem;
  }
  .chart-header h4, .chart-header h3{
    margin:0; color:#222; font-size:1rem; line-height:1.2;
  }
  .chart-subtitle, .chart-sub{ margin-top:.25rem; color:#777; font-size:.85rem; }
  .chart-body{ position:relative; width:100%; height:220px; }
  .chart-body canvas{ display:block; width:100% !important; height:100% !important; }

  .dropdown{ position:relative; }
  .dropdown-btn{
    background:transparent; border:0; font-size:1.25rem; line-height:1;
    padding:.25rem .4rem; cursor:pointer; color:#444; border-radius:8px;
  }
  .dropdown-btn:hover{ background:#f1f3f7; }
  .dropdown-menu{
    position:absolute; right:0; top:110%;
    background:#fff; border:1px solid #e7e9ef; border-radius:10px;
    min-width:220px; box-shadow:0 10px 24px rgba(0,0,0,.08);
    display:none; padding:.4rem; z-index:20;
  }
  .dropdown.open .dropdown-menu{ display:block; }
  .dropdown-menu button{
    width:100%; text-align:left; background:transparent; border:0;
    padding:.6rem .7rem; border-radius:8px; cursor:pointer; color:#2b2f36; font-size:.95rem;
  }
  .dropdown-menu button:hover{ background:#f6f7fb; }

  /* ============================ */
  /* Panel de b√∫squeda lateral (fixed) */
  /* ============================ */
  #buscadorLateral{
    position:fixed; top:0; right:-400px; width:360px; height:100%;
    background:#fff; box-shadow:-2px 0 12px rgba(0,0,0,.1);
    padding:1.5rem; transition:right .3s ease; z-index:1000; overflow-y:auto;
  }

  /* ============================ */
  /* Mejoras para el buscador lateral */
  /* ============================ */
  .buscador-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .buscador-header h3 {
    margin: 0;
    color: #333;
  }

  .buscador-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    padding: 0.25rem;
    line-height: 1;
  }

  .buscador-close:hover {
    color: #333;
  }

  .resultado-item {
    padding: 0.75rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
  }

  .resultado-item:hover {
    background-color: #f8f9fa;
  }

  .resultado-item:last-child {
    border-bottom: none;
  }

  .resultado-nombre {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
  }

  .resultado-nombre a {
    display: block;
    text-decoration: none;
    color: #333;
    font-weight: 600;
    padding: 0.25rem 0;
  }

  .resultado-nombre a:hover {
    text-decoration: underline;
    color: #667eea;
  }

  .resultado-tipo {
    font-size: 0.85rem;
    color: #666;
    text-transform: capitalize;
  }

  .resultado-accion {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px dashed #eee;
  }

  .btn-agregar {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .btn-agregar:hover {
    background: #5a6fd8;
  }

  .btn-agregar:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .estado-amistad {
    font-size: 0.8rem;
    color: #666;
    font-style: italic;
  }

  .cargando {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .sin-resultados {
    text-align: center;
    padding: 2rem;
    color: #999;
    font-style: italic;
  }

  /* ============================ */
  /* Modal ligero reutilizable */
  /* ============================ */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:2000; }
  .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:2001; display:none; }
  .modal.open, .modal-backdrop.open{ display:block; }
  .modal-card{
    width:min(92vw,520px); background:#fff; border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.2); padding:1rem 1rem 1.25rem;
  }
  .modal-card h3{ margin:.25rem 0 1rem; font-size:1.1rem; }
  .modal-actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem; }
  .modal-card label{ display:block; font-size:.9rem; color:#333; margin:.5rem 0 .25rem; }
  .modal-card select, .modal-card input[type="color"], .modal-card input[type="text"], .modal-card input[type="number"]{
    width:100%; padding:.55rem .6rem; border:1px solid #e2e5ee; border-radius:10px;
  }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
  .btn{ padding:.55rem .8rem; border-radius:10px; border:1px solid #d9deea; background:#f6f7fb; cursor:pointer; }
  .btn.primary{ background:#667eea; border-color:#667eea; color:#fff; }

  /* ============================ */
  /* Chart comparativo full-width */
  /* ============================ */
  .chart-card.full{ grid-column:1 / -1; min-height:260px; margin-bottom:1rem; }
  .chart-card.full .chart-body{ height:220px; }


  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
  <h2>Mi Panel</h2>

  <div class="sidebar-nav">
    <a href="/usuarios">Dashboard</a>
    <a href="/mis-entrenos">Mis Entrenos</a>
    <a href="/mis-dietas">Mis Dietas</a>
    <a href="/formulario-entreno">Crear Plan</a>
    <a href="/mis-comidas">Registrar Progreso</a>
    <a href="/ajustes">Ajustes</a>

    {% if gimnasio_principal %}
      <hr style="margin: 1rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.3)">
      <h3 style="margin: 1rem 0 0.5rem; font-size: 1rem;">Gimnasio Principal</h3>
      <a href="/gimnasio/{{ gimnasio_principal.id }}">{{ gimnasio_principal.nombre }}</a>
    {% endif %}

    <a href="/gimnasios">Gimnasios que sigo</a>
    <a href="#" id="link-buscar" onclick="abrirBuscador()">üîç Buscar</a>
    <a href="/notificaciones" id="link-notificaciones">
      üîî Notificaciones
      {% if num_noti_noleidas and num_noti_noleidas > 0 %}
        <span style="background:#e74c3c; color:white; border-radius:8px; font-size:0.9rem; padding:2px 8px; margin-left:8px;">{{ num_noti_noleidas }}</span>
      {% endif %}
    </a>
</div>

  <!-- Bloque de perfil abajo -->
  <a href="/mi-perfil" class="sidebar-item sidebar-profile-link">
  <img
    class="sidebar-avatar"
    src="{{ request.url_for('static', path=usuario.imagen_url) }}"
    alt="Foto de {{ usuario.nombre or 'tu perfil' }}"
    onerror="this.onerror=null; this.src='{{ request.url_for('static', path=DEFAULT_AVATAR_REL) }}'"
  />
  <span class="sidebar-label">{{ usuario.nombre or 'Tu perfil' }}</span>
</a>

  <!-- Bot√≥n de cerrar sesi√≥n -->
  <div class="sidebar-logout">
    <a href="/login" class="sidebar-item">
      üö™ Cerrar Sesi√≥n
    </a>
  </div>

</div>
  <!-- MAIN -->
  <div class="main">
    <!-- Top cards (KPIs con deltas) -->
    <div class="dashboard">
  <!-- Peso -->
  <div class="card">
    <h3>Peso Actual</h3>
    <div class="kpi-value">{{ peso|default(0, true) }} kg</div>
    <div class="kpi-delta {{ cls_peso|default('kpi-flat') }}">
      <span class="arrow">{{ arrow_peso|default('‚Äî') }}</span>
      {% if delta_peso is defined and delta_peso is not none %}
        <span>{{ delta_peso }}%</span>
      {% else %}
        <span>sin cambio</span>
      {% endif %}
    </div>
    <div class="kpi-sub">
      Objetivo:
      {% if peso_goal is defined and peso_goal == 'subir_peso' %}
        subir
      {% elif peso_goal is defined and peso_goal == 'bajar_peso' %}
        bajar
      {% else %}
        mantener
      {% endif %} peso
    </div>
  </div>

  <!-- Entrenos completados -->
  <div class="card">
    <h3>Entrenos Completados</h3>
    <div class="kpi-value">{{ entrenos|default(0, true) }} sesiones</div>
    <div class="kpi-delta {{ cls_entren|default('kpi-flat') }}">
      <span class="arrow">{{ arrow_entren|default('‚Äî') }}</span>
      {% if delta_entren is defined and delta_entren is not none %}
        <span>{{ delta_entren }}%</span>
      {% else %}
        <span>sin cambio</span>
      {% endif %}
    </div>
    <div class="kpi-sub">Comparado con el per√≠odo anterior</div>
  </div>

  <!-- D√≠as activo en el plan -->
  <div class="card">
    <h3>D√≠as Activo en el Plan</h3>
    <div class="kpi-value">{{ dias|default(0, true) }} d√≠as</div>
    <div class="kpi-delta {{ cls_dias|default('kpi-flat') }}">
      <span class="arrow">{{ arrow_dias|default('‚Äî') }}</span>
      {% if delta_dias is defined and delta_dias is not none %}
        <span>{{ delta_dias }}%</span>
      {% else %}
        <span>sin cambio</span>
      {% endif %}
    </div>
    <div class="kpi-sub">
      {% if delta_dias is defined and delta_dias is not none and delta_dias < 0 %}
        Has perdido continuidad recientemente
      {% else %}
        Vas sumando d√≠as de actividad
      {% endif %}
    </div>
  </div>

  <!-- Adherencia -->
  <div class="card">
    <h3>Adherencia</h3>
    <div class="kpi-value">{{ adherencia|default(0, true) }}%</div>
    <div class="kpi-delta {{ cls_adher|default('kpi-flat') }}">
      <span class="arrow">{{ arrow_adher|default('‚Äî') }}</span>
      {% if delta_adher is defined and delta_adher is not none %}
        <span>{{ delta_adher }}%</span>
      {% else %}
        <span>sin cambio</span>
      {% endif %}
    </div>
    <div class="kpi-sub">Media simple de tus se√±ales disponibles</div>
  </div>
</div>


    <!-- Stats section -->
    <div class="stats">
      <h3>Estad√≠sticas</h3>

      <!-- Comparativo full-width arriba -->
      <div class="chart-card full" data-chart-id="comparativo">
        <div class="chart-header">
          <div>
            <h3 class="chart-title">Comparativo</h3>
            <p class="chart-sub" data-chart-subtitle>Sin datos</p>
          </div>
          <div class="dropdown">
            <button class="dropdown-btn" aria-expanded="false" aria-label="Ajustes">‚ãÆ</button>
            <div class="dropdown-menu">
              <button type="button" data-action="change-stat">Cambiar estad√≠stica</button>
              <button type="button" data-action="change-interval">Cambiar intervalo</button>
              <button type="button" data-action="chart-settings">Ajustes del gr√°fico</button>
              <hr>
              <button type="button" data-action="choose-friends">Elegir amigos‚Ä¶</button>
            </div>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="graficoComparativo"></canvas>
        </div>
      </div>

      <!-- Grid de 3 charts (sin datos por defecto; con men√∫s listos para el punto 2) -->
      <div class="chart-grid">
        <div class="chart-card" data-chart-id="1">
          <div class="chart-header">
            <div>
              <h4 class="chart-title">Gr√°fica de peso</h4>
              <div class="chart-subtitle" data-chart-subtitle>Sin datos</div>
            </div>
            <div class="dropdown">
              <button class="dropdown-btn" aria-haspopup="true" aria-expanded="false" title="Opciones">‚ãÆ</button>
              <div class="dropdown-menu">
                <button type="button" data-action="change-stat">Cambiar estad√≠stica</button>
                <button type="button" data-action="change-interval">Cambiar intervalo</button>
                <button type="button" data-action="chart-settings">Ajustes del gr√°fico</button>
              </div>
            </div>
          </div>
          <div class="chart-body" id="chart-body-1">
            <div class="no-data">‚ö†Ô∏è A√∫n no has seleccionado ninguna estad√≠stica.</div>
          </div>
        </div>

        <div class="chart-card" data-chart-id="2">
          <div class="chart-header">
            <div>
              <h4 class="chart-title">Adherencia entrenos</h4>
              <div class="chart-subtitle" data-chart-subtitle>Sin datos</div>
            </div>
            <div class="dropdown">
              <button class="dropdown-btn" aria-haspopup="true" aria-expanded="false" title="Opciones">‚ãÆ</button>
              <div class="dropdown-menu">
                <button type="button" data-action="change-stat">Cambiar estad√≠stica</button>
                <button type="button" data-action="change-interval">Cambiar intervalo</button>
                <button type="button" data-action="chart-settings">Ajustes del gr√°fico</button>
              </div>
            </div>
          </div>
          <div class="chart-body" id="chart-body-2">
            <div class="no-data">‚ö†Ô∏è A√∫n no has seleccionado ninguna estad√≠stica.</div>
          </div>
        </div>

        <div class="chart-card" data-chart-id="3">
          <div class="chart-header">
            <div>
              <h4 class="chart-title">Adherencia dieta</h4>
              <div class="chart-subtitle" data-chart-subtitle>Sin datos</div>
            </div>
            <div class="dropdown">
              <button class="dropdown-btn" aria-haspopup="true" aria-expanded="false" title="Opciones">‚ãÆ</button>
              <div class="dropdown-menu">
                <button type="button" data-action="change-stat">Cambiar estad√≠stica</button>
                <button type="button" data-action="change-interval">Cambiar intervalo</button>
                <button type="button" data-action="chart-settings">Ajustes del gr√°fico</button>
              </div>
            </div>
          </div>
          <div class="chart-body" id="chart-body-3">
            <div class="no-data">‚ö†Ô∏è A√∫n no has seleccionado ninguna estad√≠stica.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de b√∫squeda lateral -->
  <div id="buscadorLateral">
    <div class="buscador-header">
      <h3>Buscar usuarios y gimnasios</h3>
      <button class="buscador-close" onclick="cerrarBuscador()">&times;</button>
    </div>

    <input
      type="text"
      id="inputBusqueda"
      placeholder="Escribe un nombre..."
      style="width:100%; padding:0.75rem; margin-bottom:1rem; border-radius:8px; border:1px solid #ddd;"
      oninput="buscarEnTiempoReal(this.value)"
    >

    <div id="estadoBusqueda">
      <!-- Aqu√≠ se mostrar√°n mensajes de carga, resultados, etc. -->
    </div>

    <ul id="resultadosBusqueda" style="margin-top:1rem; list-style:none; padding:0;"></ul>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /* ====== Utilidades ====== */
    function mkRGBA(hex, alpha=0.15){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex || "#667eea");
      if (!m) return `rgba(102,126,234,${alpha})`;
      const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    /* Opciones de estad√≠sticas/intervalos (para men√∫s) */
    const STAT_OPTIONS = [
      { key: "peso", label: "Peso (kg)" },
      { key: "adherencia_dieta", label: "Adherencia dieta (%)" },
      { key: "adherencia_entrenos", label: "Adherencia entrenos (%)" },
      { key: "entrenos_completados", label: "Entrenos completados" },
      { key: "dias_activo", label: "D√≠as activo" },
      { key: "distancia", label: "Distancia (km)" },
      { key: "peso_levantado", label: "Peso levantado (kg)" },
      { key: "tiempo_entreno", label: "Tiempo de entreno (min)" },
    ];
    const INTERVAL_OPTIONS = [
      { key: "7d", label: "√öltimos 7 d√≠as" },
      { key: "14d", label: "√öltimos 14 d√≠as" },
      { key: "30d", label: "√öltimos 30 d√≠as" },
      { key: "12w", label: "√öltimas 12 semanas" },
      { key: "6m", label: "√öltimos 6 meses" },
      { key: "1y", label: "√öltimo a√±o" },
    ];

    /* ====== BUSCADOR LATERAL ====== */

    let timeoutBusqueda = null;

    function abrirBuscador() {
      const panel = document.getElementById('buscadorLateral');
      if (panel) {
        panel.style.right = '0';
        // Enfocar el input cuando se abre
        setTimeout(() => {
          const input = document.getElementById('inputBusqueda');
          if (input) {
            input.focus();
            input.value = ''; // Limpiar b√∫squeda anterior
          }
          mostrarEstadoInicial();
        }, 100);
      }
    }

    function cerrarBuscador() {
      const panel = document.getElementById('buscadorLateral');
      if (panel) {
        panel.style.right = '-400px';
      }
    }

    function mostrarEstadoInicial() {
      const estado = document.getElementById('estadoBusqueda');
      const resultados = document.getElementById('resultadosBusqueda');

      if (estado) {
        estado.innerHTML = '<div class="sin-resultados">Escribe algo para buscar usuarios, gimnasios o profesionales</div>';
      }
      if (resultados) {
        resultados.innerHTML = '';
      }
    }

    function mostrarCargando() {
      const estado = document.getElementById('estadoBusqueda');
      const resultados = document.getElementById('resultadosBusqueda');

      if (estado) {
        estado.innerHTML = '<div class="cargando">Buscando...</div>';
      }
      if (resultados) {
        resultados.innerHTML = '';
      }
    }

    function mostrarResultados(resultados) {
      const estado = document.getElementById('estadoBusqueda');
      const contenedorResultados = document.getElementById('resultadosBusqueda');

      if (estado) {
        estado.innerHTML = '';
      }

      if (!contenedorResultados) return;

      if (!resultados || resultados.length === 0) {
        contenedorResultados.innerHTML = '<div class="sin-resultados">No se encontraron resultados</div>';
        return;
      }

      const html = resultados.map(item => {
        let botonHtml = '';
        let estadoHtml = '';
        let url = item.url || '#';

        // Crear enlace para el nombre que sea clicable
        const nombreConEnlace = `
          <a href="${url}"
             style="color: #333; text-decoration: none; display: block;"
             onmouseover="this.style.textDecoration='underline'"
             onmouseout="this.style.textDecoration='none'"
             title="Ver perfil">
            ${item.nombre}
          </a>
        `;

        if (item.tipo === 'Usuario') {
          if (item.estado_amistad === 'no_amigos') {
            botonHtml = `<button class="btn-agregar" onclick="agregarAmigo(${item.id})">Agregar amigo</button>`;
          } else if (item.estado_amistad === 'pendiente') {
            estadoHtml = `<div class="estado-amistad">Solicitud enviada</div>`;
          } else if (item.estado_amistad === 'aceptado') {
            estadoHtml = `<div class="estado-amistad">Ya son amigos</div>`;
          }
        } else if (item.tipo === 'Gimnasio') {
          if (!item.unido) {
            botonHtml = `<button class="btn-agregar" onclick="unirseGimnasio(${item.id})">Unirse</button>`;
          } else {
            estadoHtml = `<div class="estado-amistad">Ya est√°s unido</div>`;
          }
        } else if (item.tipo === 'Entrenador' || item.tipo === 'Dietista') {
          if (!item.seguido) {
            botonHtml = `<button class="btn-agregar" onclick="seguirProfesional(${item.id}, '${item.tipo.toLowerCase()}')">Seguir</button>`;
          } else {
            estadoHtml = `<div class="estado-amistad">Ya sigues a este profesional</div>`;
          }
        }

        return `
          <li class="resultado-item">
            <div class="resultado-nombre">${nombreConEnlace}</div>
            <div class="resultado-tipo">${item.tipo}</div>
            ${estadoHtml}
            <div class="resultado-accion">${botonHtml}</div>
          </li>
        `;
      }).join('');

      contenedorResultados.innerHTML = html;
    }

    function buscarEnTiempoReal(query) {
      // Limpiar timeout anterior
      if (timeoutBusqueda) {
        clearTimeout(timeoutBusqueda);
      }

      // Si la query est√° vac√≠a, mostrar estado inicial
      if (!query || query.trim().length < 2) {
        mostrarEstadoInicial();
        return;
      }

      // Mostrar estado de carga
      mostrarCargando();

      // Esperar 300ms antes de buscar (debounce)
      timeoutBusqueda = setTimeout(async () => {
        try {
          const response = await fetch(`/api/buscar?q=${encodeURIComponent(query.trim())}`);
          if (!response.ok) {
            throw new Error('Error en la b√∫squeda');
          }
          const resultados = await response.json();
          mostrarResultados(resultados);
        } catch (error) {
          console.error('Error buscando:', error);
          const estado = document.getElementById('estadoBusqueda');
          if (estado) {
            estado.innerHTML = '<div class="sin-resultados">Error al buscar. Intenta nuevamente.</div>';
          }
        }
      }, 300);
    }

    // Funciones para las acciones
    async function agregarAmigo(amigoId) {
      try {
        const response = await fetch('/amigos/agregar-ajax', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `amigo_id=${amigoId}`
        });

        const data = await response.json();

        if (data.status === 'ok') {
          // Actualizar la interfaz
          const boton = document.querySelector(`button[onclick="agregarAmigo(${amigoId})"]`);
          if (boton) {
            if (data.estado === 'pendiente') {
              boton.outerHTML = '<div class="estado-amistad">Solicitud enviada</div>';
            } else {
              boton.outerHTML = '<div class="estado-amistad">Ya son amigos</div>';
            }
          }
        } else {
          alert('Error: ' + data.msg);
        }
      } catch (error) {
        console.error('Error agregando amigo:', error);
        alert('Error al agregar amigo');
      }
    }

    async function unirseGimnasio(gimnasioId) {
      try {
        const response = await fetch('/unirse-gimnasio', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `gimnasio_id=${gimnasioId}`
        });

        if (response.ok) {
          // Actualizar la interfaz
          const boton = document.querySelector(`button[onclick="unirseGimnasio(${gimnasioId})"]`);
          if (boton) {
            boton.outerHTML = '<div class="estado-amistad">Ya est√°s unido</div>';
          }
        } else {
          alert('Error al unirse al gimnasio');
        }
      } catch (error) {
        console.error('Error uni√©ndose al gimnasio:', error);
        alert('Error al unirse al gimnasio');
      }
    }

    async function seguirProfesional(profesionalId, tipo) {
      try {
        const response = await fetch('/profesionales/unirse', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `profesional_id=${profesionalId}&tipo=${tipo}`
        });

        if (response.ok) {
          // Actualizar la interfaz
          const boton = document.querySelector(`button[onclick="seguirProfesional(${profesionalId}, '${tipo}')"]`);
          if (boton) {
            boton.outerHTML = '<div class="estado-amistad">Ya sigues a este profesional</div>';
          }
        } else {
          alert(`Error al seguir al ${tipo}`);
        }
      } catch (error) {
        console.error(`Error siguiendo al ${tipo}:`, error);
        alert(`Error al seguir al ${tipo}`);
      }
    }

    /* ====== Modal ligero reutilizable ====== */
    const Modal = (() => {
      let backdrop, wrapper, form, title;
      function ensure(){
        if (wrapper) return;
        backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        wrapper = document.createElement('div');
        wrapper.className = 'modal';
        const card = document.createElement('div');
        card.className = 'modal-card';
        title = document.createElement('h3');
        form = document.createElement('form');
        const actions = document.createElement('div');
        actions.className = 'modal-actions';
        const cancel = document.createElement('button');
        cancel.type = 'button'; cancel.className='btn'; cancel.textContent='Cancelar';
        const ok = document.createElement('button');
        ok.type = 'submit'; ok.className='btn primary'; ok.textContent='Aplicar';
        actions.append(cancel, ok);
        card.append(title, form, actions);
        wrapper.append(card);
        document.body.append(backdrop, wrapper);

        cancel.addEventListener('click', close);
        backdrop.addEventListener('click', close);
        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const fd = new FormData(form);
          if (wrapper._onSubmit) wrapper._onSubmit(fd, close);
        });
      }
      function open({ titleText="Opciones", html="", onSubmit }){
        ensure();
        title.textContent = titleText;
        form.innerHTML = html;
        wrapper._onSubmit = onSubmit;
        backdrop.classList.add('open');
        wrapper.classList.add('open');
      }
      function close(){
        if (!wrapper) return;
        backdrop.classList.remove('open');
        wrapper.classList.remove('open');
        wrapper._onSubmit = null;
      }
      return { open, close };
    })();

    /* ========= Estado & helpers del comparativo ========= */
    const COMP_PREFS_KEY = "dashboardComparativo:v1";
    const COMP_DEFAULT = { stat: null, interval: "7d", type: "line", color: "#667eea", friends: [] };
    function loadCompPrefs(){ try{ return { ...COMP_DEFAULT, ...(JSON.parse(localStorage.getItem(COMP_PREFS_KEY))||{}) }; }catch{ return { ...COMP_DEFAULT }; } }
    function saveCompPrefs(p){ localStorage.setItem(COMP_PREFS_KEY, JSON.stringify(p)); }
    let compState = loadCompPrefs();

    function ensureComparativeCanvas(){
      const cmpCanvas = document.getElementById('graficoComparativo');
      if (!cmpCanvas) return null;
      const body = cmpCanvas.closest('.chart-body') || cmpCanvas.parentElement;
      if (!body) return null;
      if (!body.querySelector('canvas')) {
        body.innerHTML = `<canvas id="graficoComparativo"></canvas>`;
      }
      return document.getElementById('graficoComparativo');
    }
    function renderNoDataComparativo(msg="‚ö†Ô∏è No hay datos comparativos."){
      const cmpCanvas = ensureComparativeCanvas();
      if (!cmpCanvas) return;
      const body = cmpCanvas.closest('.chart-body') || cmpCanvas.parentElement;
      body.innerHTML = `
        <div class="no-data" style="height:100%;min-height:160px;display:flex;align-items:center;justify-content:center;color:#777;font-style:italic;text-align:center;padding:1rem;">
          <p>${msg}</p>
        </div>`;
    }
    function sizeCanvas(c){
      if (!c || !c.parentElement) return;
      const w = c.parentElement.getBoundingClientRect();
      c.width = Math.max(120, Math.floor(w.width));
      c.height = Math.max(160, Math.floor(w.height));
    }
    function mkPalette(n){
      const base = ["#667eea","#22a6b3","#e67e22","#8e44ad","#0fb9b1","#e74c3c","#2ecc71","#f1c40f"];
      const out=[]; for (let i=0;i<n;i++) out.push(base[i % base.length]);
      return out;
    }
    window.compChart = null;
    function renderComparativeChart(labels, series, type="line"){
      const canvas = ensureComparativeCanvas();
      if (!canvas) return;
      sizeCanvas(canvas);
      if (window.compChart) { window.compChart.destroy(); window.compChart = null; }
      const palette = mkPalette(series.length);
      const datasets = series.map((s,idx) => {
        const color = s.color || palette[idx];
        return {
          label: s.label || s.name || `Serie ${idx+1}`,
          data: (s.data||[]).map(v => (v==null? null : Number(v))),
          borderColor: color,
          backgroundColor: mkRGBA(color),
          fill: type === 'line',
          tension: 0.35,
          pointRadius: 3
        };
      });
      window.compChart = new Chart(canvas.getContext('2d'), {
        type: (type==='bar'?'bar':'line'),
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'top' } },
          scales: {
            y: { beginAtZero: false, ticks: { maxTicksLimit: 6 } },
            x: { ticks: { maxRotation: 0, autoSkip: true } }
          }
        }
      });
    }
    async function loadComparative(statKey, intervalKey, type, friendsIds){
      compState = {
        stat: statKey || compState.stat,
        interval: intervalKey || compState.interval,
        type: (type || compState.type || 'line'),
        friends: Array.isArray(friendsIds) ? friendsIds : (compState.friends || [])
      };
      saveCompPrefs(compState);

      // T√≠tulo/subt√≠tulo
      const card = document.querySelector('.chart-card[data-chart-id="comparativo"]');
      if (card){
        const titleEl = card.querySelector('.chart-title');
        if (titleEl) titleEl.textContent = statKey ? (STAT_OPTIONS.find(x=>x.key===statKey)?.label || "Comparativo") : "Comparativo";
        const sub = card.querySelector('[data-chart-subtitle]');
        const intLabel = INTERVAL_OPTIONS.find(i=>i.key===compState.interval)?.label || "Sin datos";
        if (sub) sub.textContent = `${intLabel} ¬∑ ${compState.type==='bar'?'Barras':'L√≠nea'}`;
      }

      try{
        const q = new URLSearchParams();
        q.set('stat', compState.stat || '');
        q.set('interval', compState.interval || '7d');
        if (compState.friends?.length) q.set('friends', compState.friends.join(','));
        const res = await fetch(`/api/estadisticas/comparativo?${q.toString()}`);
        if (!res.ok) throw new Error(`API error ${res.status}`);
        const payload = await res.json(); // { labels:[], series:[{userId,name,data}]}
        const { labels, series } = payload || {};
        if (!Array.isArray(labels) || !Array.isArray(series) || series.length===0) {
          renderNoDataComparativo();
          return;
        }
        renderComparativeChart(labels, series, compState.type);
      }catch(err){
        console.error('Comparativo: error', err);
        renderNoDataComparativo("‚ö†Ô∏è No se pudieron cargar los datos.");
      }
    }

    /* ===== Men√∫s del comparativo ===== */
    async function fetchFriends(){
      try{ const res = await fetch('/api/amigos'); if (!res.ok) return []; return await res.json(); }
      catch{ return []; }
    }
    function openComparativeChangeStat(){
      const opts = STAT_OPTIONS.map(s => `<option value="${s.key}" ${s.key===compState.stat?'selected':''}>${s.label}</option>`).join('');
      Modal.open({
        titleText: "Comparativo ¬∑ Cambiar estad√≠stica",
        html: `
          <label>Estad√≠stica</label>
          <select name="stat" required>
            <option value="" disabled ${!compState.stat?'selected':''}>Selecciona una estad√≠stica</option>
            ${opts}
          </select>
        `,
        onSubmit: (fd, close)=>{ const stat = fd.get('stat'); loadComparative(stat, compState.interval, compState.type, compState.friends); close(); }
      });
    }
    function openComparativeChangeInterval(){
      const opts = INTERVAL_OPTIONS.map(i => `<option value="${i.key}" ${i.key===compState.interval?'selected':''}>${i.label}</option>`).join('');
      Modal.open({
        titleText: "Comparativo ¬∑ Cambiar intervalo",
        html: `
          <label>Intervalo</label>
          <select name="interval" required>
            ${opts}
          </select>
        `,
        onSubmit: (fd, close)=>{ const interval = fd.get('interval'); loadComparative(compState.stat, interval, compState.type, compState.friends); close(); }
      });
    }
    function openComparativeChartSettings(){
      Modal.open({
        titleText: "Comparativo ¬∑ Ajustes del gr√°fico",
        html: `
          <div class="row">
            <div>
              <label>Tipo</label>
              <select name="type" required>
                <option value="line" ${compState.type==='line'?'selected':''}>L√≠nea</option>
                <option value="bar" ${compState.type==='bar'?'selected':''}>Barras</option>
              </select>
            </div>
          </div>
        `,
        onSubmit: (fd, close)=>{ const type = fd.get('type') || 'line'; loadComparative(compState.stat, compState.interval, type, compState.friends); close(); }
      });
    }
    async function openComparativeSelectFriends(){
      const friends = await fetchFriends();
      const selected = new Set((compState.friends||[]).map(x=>String(x)));
      const list = friends.map(f => `
        <label style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0;">
          <input type="checkbox" name="friend" value="${f.id}" ${selected.has(String(f.id))?'checked':''} />
          <span>${f.nombre || ('Usuario '+f.id)}</span>
        </label>
      `).join('') || `<p style="color:#666">No tienes amigos para comparar todav√≠a.</p>`;
      Modal.open({
        titleText: "Comparativo ¬∑ Elegir amigos",
        html: `
          <div style="max-height:260px; overflow:auto; border:1px solid #e2e5ee; border-radius:10px; padding:.5rem;">
            ${list}
          </div>
          <p style="margin-top:.5rem; font-size:.85rem; color:#666">Puedes seleccionar varios.</p>
        `,
        onSubmit: (fd, close)=>{ const newSel = fd.getAll('friend').map(String); compState.friends = newSel; saveCompPrefs(compState); loadComparative(compState.stat, compState.interval, compState.type, compState.friends); close(); }
      });
    }
    function wireComparativeDropdown(){
      const card = document.querySelector('.chart-card[data-chart-id="comparativo"]');
      if (!card) return;
      const btn = card.querySelector('.dropdown-btn');
      btn?.addEventListener('click', (e)=>{
        e.stopPropagation();
        const dd = btn.closest('.dropdown');
        const isOpen = dd.classList.contains('open');
        document.querySelectorAll('.chart-card .dropdown').forEach(x => x.classList.remove('open'));
        if (!isOpen) dd.classList.add('open');
      });
      document.addEventListener('click', () => card.querySelector('.dropdown')?.classList.remove('open'));
      card.querySelectorAll('.dropdown-menu [data-action]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const a = b.dataset.action;
          if (a==='change-stat') openComparativeChangeStat();
          else if (a==='change-interval') openComparativeChangeInterval();
          else if (a==='chart-settings') openComparativeChartSettings();
          else if (a==='choose-friends') openComparativeSelectFriends();
          card.querySelector('.dropdown')?.classList.remove('open');
        });
      });
    }

    /* Cierre global de men√∫s con click fuera / Escape */
    document.addEventListener('click', () => {
      document.querySelectorAll('.chart-card .dropdown').forEach(x => x.classList.remove('open'));
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.chart-card .dropdown').forEach(x => x.classList.remove('open'));
      }
    });

    // Cerrar buscador al hacer clic fuera
    document.addEventListener('click', (event) => {
      const buscador = document.getElementById('buscadorLateral');
      const target = event.target;

      if (buscador &&
          !buscador.contains(target) &&
          target.id !== 'link-buscar' &&
          !target.closest('#link-buscar')) {
        cerrarBuscador();
      }
    });

    // Tambi√©n cerrar con Escape
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        cerrarBuscador();
      }
    });

    /* Init */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Inicializar el buscador
      mostrarEstadoInicial();

      // comparativo
      const card = document.querySelector('.chart-card[data-chart-id="comparativo"]');
      if (card){
        wireComparativeDropdown();
        if (compState.stat) {
          loadComparative(compState.stat, compState.interval, compState.type, compState.friends);
        } else {
          const sub = card.querySelector('[data-chart-subtitle]');
          if (sub) sub.textContent = "Sin datos";
          renderNoDataComparativo();
        }
      }
      // los 3 charts inferiores quedan en "Sin datos" por defecto (punto 2 los haremos funcionales)
    });
  </script>
</body>
</html>